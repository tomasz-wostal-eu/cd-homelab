# Grafana Alloy configuration for homelab
# Logs and traces collection only (metrics handled by Prometheus)

# Alloy configuration
alloy:
  # Config file content (River format)
  configMap:
    content: |
      // Logging configuration
      logging {
        level  = "info"
        format = "logfmt"
      }

      // ============================================
      // DISCOVERY
      // ============================================

      // Kubernetes service discovery for pods
      discovery.kubernetes "pods" {
        role = "pod"
      }

      // ============================================
      // LOGS COLLECTION
      // ============================================

      // Discover and collect logs from pods
      loki.source.kubernetes "pods" {
        targets    = discovery.kubernetes.pods.targets
        forward_to = [loki.process.pods.receiver]
      }

      // Process logs - add labels
      loki.process "pods" {
        forward_to = [loki.write.loki.receiver]

        stage.static_labels {
          values = {
            cluster = "homelab",
          }
        }
      }

      // Write logs to Loki
      loki.write "loki" {
        endpoint {
          url = "http://loki.monitoring.svc:3100/loki/api/v1/push"
        }
      }

      // ============================================
      // TRACES COLLECTION
      // ============================================

      // OTLP receiver for traces
      otelcol.receiver.otlp "default" {
        grpc {
          endpoint = "0.0.0.0:4317"
        }
        http {
          endpoint = "0.0.0.0:4318"
        }

        output {
          traces = [otelcol.exporter.otlp.tempo.input]
        }
      }

      // Export traces to Tempo
      otelcol.exporter.otlp "tempo" {
        client {
          endpoint = "tempo.monitoring.svc:4317"

          tls {
            insecure = true
          }
        }
      }

# Deployment as DaemonSet to collect logs from all nodes
controller:
  type: daemonset

# Resources - reduced since no metrics
resources:
  requests:
    cpu: 25m
    memory: 64Mi
  limits:
    cpu: 200m
    memory: 256Mi

# Service account
serviceAccount:
  create: true

# RBAC
rbac:
  create: true

# Tolerations to run on all nodes
tolerations:
  - operator: Exists

# Service
service:
  enabled: true
  type: ClusterIP

# Security context
securityContext:
  privileged: true
  runAsUser: 0

# Pod annotations
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "12345"
  prometheus.io/path: "/metrics"

# Extra mounts for log collection
extraVolumes:
  - name: varlog
    hostPath:
      path: /var/log
  - name: varlibdockercontainers
    hostPath:
      path: /var/lib/docker/containers

extraVolumeMounts:
  - name: varlog
    mountPath: /var/log
    readOnly: true
  - name: varlibdockercontainers
    mountPath: /var/lib/docker/containers
    readOnly: true
