# Telegraf: EMQX MQTT â†’ InfluxDB

# Load InfluxDB token from secret
envFromSecret: "homelab-telegraf-credentials"

config:
  agent:
    interval: "10s"
    round_interval: true
    metric_batch_size: 1000
    metric_buffer_limit: 10000
    flush_interval: "10s"
    flush_jitter: "0s"
    debug: false

  outputs:
    - influxdb_v2:
        urls:
          - "http://influxdb-influxdb2.monitoring.svc.cluster.local:80"
        token: "$INFLUX_TOKEN"
        organization: "homelab"
        bucket: "mqtt"

  inputs:
    # Hydrosense aquarium data
    - mqtt_consumer:
        name_override: "hydrosense"
        servers:
          - "tcp://emqx.emqx.svc.cluster.local:1883"
        topics:
          - "hydrosense/+/+/state"
        qos: 1
        connection_timeout: "30s"
        persistent_session: false
        client_id: "telegraf-hydrosense"
        keep_alive: "60s"
        max_undelivered_messages: 1000
        data_format: "json"
        topic_tag: "topic"
        json_string_fields:
          - "mode"
          - "water_level"
          - "pump_state"
          - "current_level"
          - "next_action"

    # Zigbee2MQTT sensors (power, energy, temperature, etc.)
    - mqtt_consumer:
        name_override: "zigbee"
        servers:
          - "tcp://emqx.emqx.svc.cluster.local:1883"
        topics:
          - "zigbee2mqtt/+"
        qos: 1
        connection_timeout: "30s"
        persistent_session: false
        client_id: "telegraf-zigbee"
        keep_alive: "60s"
        max_undelivered_messages: 1000
        data_format: "json"
        topic_tag: "topic"
        json_string_fields:
          - "state"
          - "indicator_mode"
          - "power_outage_memory"

# Disable service - no inputs require exposed ports
service:
  enabled: false

# Pod annotations for Prometheus
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9273"
  prometheus.io/path: "/metrics"

resources:
  requests:
    cpu: 50m
    memory: 64Mi
  limits:
    cpu: 200m
    memory: 128Mi
