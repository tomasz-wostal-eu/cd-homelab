---
# Job to configure MQTT bridge after EMQX starts
# Runs once and configures bridge via EMQX API
apiVersion: batch/v1
kind: Job
metadata:
  name: emqx-bridge-config
  namespace: emqx
  annotations:
    argocd.argoproj.io/sync-wave: "2"
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 5
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: bridge-configurator
          image: curlimages/curl:8.5.0
          envFrom:
            - secretRef:
                name: homelab-emqx-bridge
          command:
            - /bin/sh
            - -c
            - |
              set -e

              # Wait for EMQX API to be ready
              echo "Waiting for EMQX API..."
              for i in $(seq 1 60); do
                if curl -sf http://emqx.emqx.svc.cluster.local:18083/api/v5/status > /dev/null 2>&1; then
                  echo "EMQX API is ready"
                  break
                fi
                echo "EMQX not ready, waiting... ($i/60)"
                sleep 5
              done

              # Get auth token
              echo "Authenticating..."
              TOKEN=$(curl -sf -X POST http://emqx.emqx.svc.cluster.local:18083/api/v5/login \
                -H "Content-Type: application/json" \
                -d "{\"username\":\"admin\",\"password\":\"${EMQX_DASHBOARD_PASSWORD}\"}" | \
                grep -o '"token":"[^"]*"' | cut -d'"' -f4)

              if [ -z "$TOKEN" ]; then
                echo "Trying default password..."
                TOKEN=$(curl -sf -X POST http://emqx.emqx.svc.cluster.local:18083/api/v5/login \
                  -H "Content-Type: application/json" \
                  -d '{"username":"admin","password":"public"}' | \
                  grep -o '"token":"[^"]*"' | cut -d'"' -f4)
              fi

              if [ -z "$TOKEN" ]; then
                echo "ERROR: Cannot authenticate to EMQX API"
                exit 1
              fi
              echo "Authenticated successfully"

              # Check if bridge exists using HTTP status code
              echo "Checking if bridge exists..."
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $TOKEN" \
                http://emqx.emqx.svc.cluster.local:18083/api/v5/bridges/mqtt:ha_bridge)

              if [ "$HTTP_CODE" = "200" ]; then
                echo "Bridge already exists and is configured"

                # Verify bridge is connected
                BRIDGE_STATUS=$(curl -sf -H "Authorization: Bearer $TOKEN" \
                  http://emqx.emqx.svc.cluster.local:18083/api/v5/bridges/mqtt:ha_bridge | \
                  grep -o '"status":"[^"]*"' | cut -d'"' -f4)
                echo "Bridge status: $BRIDGE_STATUS"
                exit 0
              fi

              echo "Bridge not found (HTTP $HTTP_CODE), creating..."
              RESULT=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
                http://emqx.emqx.svc.cluster.local:18083/api/v5/bridges \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $TOKEN" \
                -d "{
                  \"type\": \"mqtt\",
                  \"name\": \"ha_bridge\",
                  \"enable\": true,
                  \"server\": \"${BRIDGE_SERVER}\",
                  \"proto_ver\": \"v5\",
                  \"username\": \"${BRIDGE_USERNAME}\",
                  \"password\": \"${BRIDGE_PASSWORD}\",
                  \"clean_start\": false,
                  \"ingress\": {
                    \"remote\": {\"topic\": \"#\", \"qos\": 1},
                    \"local\": {
                      \"topic\": \"\${topic}\",
                      \"qos\": \"\${qos}\",
                      \"retain\": \"\${retain}\",
                      \"payload\": \"\${payload}\"
                    }
                  }
                }")

              RESPONSE_CODE=$(echo "$RESULT" | grep "HTTP_CODE:" | cut -d: -f2)
              RESPONSE_BODY=$(echo "$RESULT" | grep -v "HTTP_CODE:")

              if [ "$RESPONSE_CODE" = "201" ] || [ "$RESPONSE_CODE" = "200" ]; then
                echo "Bridge created successfully!"
                echo "Response: $RESPONSE_BODY"
              else
                echo "Bridge creation failed (HTTP $RESPONSE_CODE)"
                echo "Response: $RESPONSE_BODY"
                exit 1
              fi
