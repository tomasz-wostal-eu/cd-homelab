---
# Configure Envoy Proxy for k3d - use hostNetwork on server node
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyProxy
metadata:
  name: homelab-proxy-config
  namespace: envoy-gateway-system
spec:
  provider:
    type: Kubernetes
    kubernetes:
      envoyService:
        # Disable service creation - we use hostNetwork
        type: ClusterIP
      envoyDeployment:
        replicas: 1
        pod:
          annotations:
            prometheus.io/scrape: "true"
        container:
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi
  # Use hostNetwork to bind directly to node ports
  # Pod must run on server-0 where k3d maps 80/443
---
# Patch: schedule Envoy on server node with hostNetwork
apiVersion: v1
kind: ConfigMap
metadata:
  name: envoy-proxy-patch-note
  namespace: envoy-gateway-system
data:
  note: |
    EnvoyProxy resource doesn't support hostNetwork directly.
    Need to patch deployment after creation or use different approach.
